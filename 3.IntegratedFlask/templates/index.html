<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– íŒ¨ìŠ¤íŒŒì¸ë” í†µí•© ì œì–´ ì‹œìŠ¤í…œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 1s ease-out;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .connection-status.connected {
            background: rgba(76, 175, 80, 0.2);
        }

        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.2);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .camera-panel {
            animation: fadeInLeft 1s ease-out;
        }

        .motor-panel {
            animation: fadeInUp 1s ease-out 0.2s both;
        }

        .sensor-panel {
            animation: fadeInRight 1s ease-out 0.4s both;
        }

        .panel h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ì¹´ë©”ë¼ íŒ¨ë„ */
        .camera-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: #000;
        }

        .camera-stream {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
        }

        .camera-stream:hover {
            transform: scale(1.02);
        }

        .camera-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        /* ëª¨í„° ì œì–´ íŒ¨ë„ */
        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .control-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            border-radius: 15px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 15px 10px;
            font-size: 0.8rem;
            position: relative;
            overflow: hidden;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }

        .control-btn.active {
            background: linear-gradient(45deg, #00b894, #00a085);
            box-shadow: 0 0 20px rgba(0,184,148,0.6);
        }

        .control-btn .icon {
            font-size: 1.2rem;
        }

        .control-btn .key-hint {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .speed-control {
            margin-top: 20px;
        }

        .speed-control label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .speed-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00ff88;
            cursor: pointer;
        }

        .speed-value {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 10px;
            color: #00ff88;
        }

        .motor-status {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .motor-status.active {
            background: rgba(0,184,148,0.2);
            color: #00ff88;
        }

        /* ì„¼ì„œ íŒ¨ë„ */
        .sensor-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .distance-display {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .distance-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .distance-unit {
            font-size: 1rem;
            opacity: 0.9;
        }

        .sensor-chart {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            height: 150px;
            position: relative;
            overflow: hidden;
        }

        .chart-bar {
            position: absolute;
            bottom: 0;
            background: linear-gradient(to top, #2196F3, #64B5F6);
            border-radius: 3px 3px 0 0;
            transition: height 0.5s ease;
            min-width: 4px;
        }

        .sensor-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            flex: 1;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(116,185,255,0.4);
        }

        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn.danger:hover {
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }

        /* í•˜ë‹¨ ì •ë³´ íŒ¨ë„ */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            animation: fadeInUp 1s ease-out;
        }

        .info-card h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-container {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-family: monospace;
            font-size: 0.8rem;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.motor {
            color: #00ff88;
        }

        .log-entry.sensor {
            color: #74b9ff;
        }

        .log-entry.error {
            color: #ff6b6b;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .camera-panel {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .control-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .sensor-stats {
                grid-template-columns: 1fr;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” ì„¹ì…˜ -->
        <div class="header">
            <h1><i class="fas fa-robot"></i> íŒ¨ìŠ¤íŒŒì¸ë” í†µí•© ì œì–´ ì‹œìŠ¤í…œ</h1>
            <p>ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë° + ì´ˆìŒíŒŒ ì„¼ì„œ + ëª¨í„° ì œì–´</p>
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-circle"></i>
                <span>ì—°ê²° ì¤‘...</span>
            </div>
        </div>

        <!-- ë©”ì¸ ê·¸ë¦¬ë“œ -->
        <div class="main-grid">
            <!-- ì¹´ë©”ë¼ íŒ¨ë„ -->
            <div class="panel camera-panel">
                <h2><i class="fas fa-video"></i> ì‹¤ì‹œê°„ ì¹´ë©”ë¼ í”¼ë“œ</h2>
                <div class="camera-container">
                    <img id="cameraStream" class="camera-stream" src="/video_feed" alt="Camera Stream">
                    <div class="camera-overlay">
                        <div class="status-dot"></div>
                        <span>LIVE</span>
                        <span id="timestamp"></span>
                    </div>
                </div>
            </div>

            <!-- ëª¨í„° ì œì–´ íŒ¨ë„ -->
            <div class="panel motor-panel">
                <h2><i class="fas fa-cog"></i> ëª¨í„° ì œì–´</h2>
                
                <div class="motor-status" id="motorStatus">ëŒ€ê¸° ì¤‘</div>
                
                <div class="control-grid">
                    <!-- ì™¼ìª½ ì•ìœ¼ë¡œ -->
                    <button class="control-btn" data-command="forward-left">
                        <i class="fas fa-arrow-up icon" style="transform: rotate(-45deg);"></i>
                        <span>ì™¼ìª½ ì•</span>
                        <span class="key-hint">Q</span>
                    </button>
                    
                    <!-- ì „ì§„ -->
                    <button class="control-btn" data-command="forward">
                        <i class="fas fa-arrow-up icon"></i>
                        <span>ì „ì§„</span>
                        <span class="key-hint">W</span>
                    </button>
                    
                    <!-- ì˜¤ë¥¸ìª½ ì•ìœ¼ë¡œ -->
                    <button class="control-btn" data-command="forward-right">
                        <i class="fas fa-arrow-up icon" style="transform: rotate(45deg);"></i>
                        <span>ì˜¤ë¥¸ìª½ ì•</span>
                        <span class="key-hint">E</span>
                    </button>
                    
                    <!-- ì¢ŒíšŒì „ -->
                    <button class="control-btn" data-command="left">
                        <i class="fas fa-arrow-left icon"></i>
                        <span>ì¢ŒíšŒì „</span>
                        <span class="key-hint">A</span>
                    </button>
                    
                    <!-- ì •ì§€ -->
                    <button class="control-btn" data-command="stop" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d);">
                        <i class="fas fa-stop icon"></i>
                        <span>ì •ì§€</span>
                        <span class="key-hint">S</span>
                    </button>
                    
                    <!-- ìš°íšŒì „ -->
                    <button class="control-btn" data-command="right">
                        <i class="fas fa-arrow-right icon"></i>
                        <span>ìš°íšŒì „</span>
                        <span class="key-hint">D</span>
                    </button>
                    
                    <!-- ì™¼ìª½ ë’¤ë¡œ -->
                    <button class="control-btn" data-command="backward-left">
                        <i class="fas fa-arrow-down icon" style="transform: rotate(45deg);"></i>
                        <span>ì™¼ìª½ ë’¤</span>
                        <span class="key-hint">Z</span>
                    </button>
                    
                    <!-- í›„ì§„ -->
                    <button class="control-btn" data-command="backward">
                        <i class="fas fa-arrow-down icon"></i>
                        <span>í›„ì§„</span>
                        <span class="key-hint">X</span>
                    </button>
                    
                    <!-- ì˜¤ë¥¸ìª½ ë’¤ë¡œ -->
                    <button class="control-btn" data-command="backward-right">
                        <i class="fas fa-arrow-down icon" style="transform: rotate(-45deg);"></i>
                        <span>ì˜¤ë¥¸ìª½ ë’¤</span>
                        <span class="key-hint">C</span>
                    </button>
                </div>
                
                <div class="speed-control">
                    <label for="speedSlider">ëª¨í„° ì†ë„</label>
                    <input type="range" id="speedSlider" class="speed-slider" min="50" max="100" value="100" step="5">
                    <div class="speed-value" id="speedValue">100%</div>
                </div>
            </div>

            <!-- ì„¼ì„œ íŒ¨ë„ -->
            <div class="panel sensor-panel">
                <h2><i class="fas fa-radar"></i> ì´ˆìŒíŒŒ ì„¼ì„œ</h2>
                
                <div class="distance-display">
                    <div class="distance-value" id="currentDistance">--</div>
                    <div class="distance-unit">cm</div>
                </div>
                
                <div class="sensor-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="measurementCount">0</div>
                        <div class="stat-label">ì¸¡ì • íšŸìˆ˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgDistance">--</div>
                        <div class="stat-label">í‰ê·  ê±°ë¦¬</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="minDistance">--</div>
                        <div class="stat-label">ìµœì†Œ ê±°ë¦¬</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="maxDistance">--</div>
                        <div class="stat-label">ìµœëŒ€ ê±°ë¦¬</div>
                    </div>
                </div>
                
                <div class="sensor-chart" id="sensorChart"></div>
                
                <div class="sensor-controls">
                    <button class="btn danger" id="clearDataBtn">
                        <i class="fas fa-trash"></i> ë°ì´í„° ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>

        <!-- ì •ë³´ íŒ¨ë„ -->
        <div class="info-grid">
            <div class="info-card">
                <h3><i class="fas fa-info-circle"></i> ì‹œìŠ¤í…œ ìƒíƒœ</h3>
                <div class="log-container" id="systemLog">
                    <div class="log-entry">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
                </div>
            </div>

            <div class="info-card">
                <h3><i class="fas fa-keyboard"></i> í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9rem;">
                    <div><kbd>W</kbd> ì „ì§„</div>
                    <div><kbd>S</kbd> ì •ì§€</div>
                    <div><kbd>X</kbd> í›„ì§„</div>
                    <div><kbd>A</kbd> ì¢ŒíšŒì „</div>
                    <div><kbd>D</kbd> ìš°íšŒì „</div>
                    <div><kbd>Q</kbd> ì™¼ìª½ ì•</div>
                    <div><kbd>E</kbd> ì˜¤ë¥¸ìª½ ì•</div>
                    <div><kbd>Z</kbd> ì™¼ìª½ ë’¤</div>
                    <div><kbd>C</kbd> ì˜¤ë¥¸ìª½ ë’¤</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ -->
    <div class="notification" id="notification"></div>

    <script>
        // WebSocket ì—°ê²°
        const socket = io();
        
        // DOM ìš”ì†Œë“¤
        const connectionStatus = document.getElementById('connectionStatus');
        const motorStatus = document.getElementById('motorStatus');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const controlButtons = document.querySelectorAll('.control-btn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const systemLog = document.getElementById('systemLog');
        const sensorChart = document.getElementById('sensorChart');
        
        // ì„¼ì„œ ë°ì´í„° í‘œì‹œ ìš”ì†Œë“¤
        const currentDistance = document.getElementById('currentDistance');
        const measurementCount = document.getElementById('measurementCount');
        const avgDistance = document.getElementById('avgDistance');
        const minDistance = document.getElementById('minDistance');
        const maxDistance = document.getElementById('maxDistance');
        
        // ìƒíƒœ ë³€ìˆ˜
        let isConnected = false;
        let activeCommand = '';
        let motorSpeed = 100;
        let chartData = [];
        const maxChartPoints = 20;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            updateTimestamp();
            setupEventListeners();
            
            // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
            setInterval(updateTimestamp, 1000);
        });
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ëª¨í„° ì œì–´ ë²„íŠ¼
            controlButtons.forEach(btn => {
                btn.addEventListener('mousedown', () => startCommand(btn.dataset.command));
                btn.addEventListener('mouseup', () => stopCommand());
                btn.addEventListener('mouseleave', () => stopCommand());
            });
            
            // ì†ë„ ìŠ¬ë¼ì´ë”
            speedSlider.addEventListener('input', function() {
                motorSpeed = parseInt(this.value);
                speedValue.textContent = `${motorSpeed}%`;
                
                if (activeCommand && isConnected) {
                    socket.emit('speed_change', { speed: motorSpeed });
                }
            });
            
            // ë°ì´í„° ì´ˆê¸°í™” ë²„íŠ¼
            clearDataBtn.addEventListener('click', function() {
                if (isConnected) {
                    socket.emit('clear_ultrasonic_data');
                }
            });
            
            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
            setupKeyboardControls();
        }
        
        // í‚¤ë³´ë“œ ì œì–´ ì„¤ì •
        function setupKeyboardControls() {
            const keyCommandMap = {
                'KeyW': 'forward',
                'KeyX': 'backward',
                'KeyA': 'left',
                'KeyD': 'right',
                'KeyQ': 'forward-left',
                'KeyE': 'forward-right',
                'KeyZ': 'backward-left',
                'KeyC': 'backward-right',
                'KeyS': 'stop'
            };
            
            document.addEventListener('keydown', (event) => {
                const command = keyCommandMap[event.code];
                if (command && !event.repeat) {
                    event.preventDefault();
                    startCommand(command);
                }
            });
            
            document.addEventListener('keyup', (event) => {
                const command = keyCommandMap[event.code];
                if (command && command !== 'stop' && activeCommand === command) {
                    event.preventDefault();
                    stopCommand();
                }
            });
        }
        
        // WebSocket ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        socket.on('connect', function() {
            isConnected = true;
            connectionStatus.innerHTML = '<i class="fas fa-circle"></i> <span>ì—°ê²°ë¨</span>';
            connectionStatus.className = 'connection-status connected';
            addLog('WebSocket ì—°ê²° ì„±ê³µ', 'system');
        });
        
        socket.on('disconnect', function() {
            isConnected = false;
            connectionStatus.innerHTML = '<i class="fas fa-circle"></i> <span>ì—°ê²° ëŠê¹€</span>';
            connectionStatus.className = 'connection-status disconnected';
            addLog('WebSocket ì—°ê²° ëŠê¹€', 'error');
        });
        
        socket.on('system_status', function(data) {
            addLog(`ì‹œìŠ¤í…œ ì—°ê²°: ${data.message}`, 'system');
        });
        
        socket.on('motor_status', function(data) {
            updateMotorStatus(data.command, data.command !== 'stop');
            addLog(`ëª¨í„°: ${getCommandName(data.command)} (${data.speed}%)`, 'motor');
        });
        
        socket.on('ultrasonic_data', function(data) {
            updateSensorDisplay(data);
            updateChart(data.distance);
            
            if (data.distance !== null) {
                addLog(`ê±°ë¦¬: ${data.distance} cm`, 'sensor');
            } else {
                addLog('ê±°ë¦¬ ì¸¡ì • ì‹¤íŒ¨', 'error');
            }
        });
        
        socket.on('ultrasonic_data_cleared', function(data) {
            clearChart();
            addLog('ì´ˆìŒíŒŒ ë°ì´í„° ì´ˆê¸°í™”ë¨', 'system');
        });
        
        // ëª…ë ¹ ì‹œì‘
        function startCommand(command) {
            if (!isConnected || activeCommand === command) return;
            
            activeCommand = command;
            updateMotorStatus(command, command !== 'stop');
            
            socket.emit('motor_command', {
                command: command,
                speed: motorSpeed
            });
        }
        
        // ëª…ë ¹ ì¤‘ì§€
        function stopCommand() {
            if (!isConnected || !activeCommand || activeCommand === 'stop') return;
            
            activeCommand = '';
            updateMotorStatus('stop', false);
            
            socket.emit('motor_command', {
                command: 'stop',
                speed: 0
            });
        }
        
        // ëª¨í„° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateMotorStatus(command, isActive) {
            // ëª¨ë“  ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
            controlButtons.forEach(btn => btn.classList.remove('active'));
            
            if (isActive && command !== 'stop') {
                motorStatus.textContent = `ì‹¤í–‰ ì¤‘: ${getCommandName(command)}`;
                motorStatus.classList.add('active');
                
                // í•´ë‹¹ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
                const activeBtn = document.querySelector(`[data-command="${command}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            } else {
                motorStatus.textContent = 'ëŒ€ê¸° ì¤‘';
                motorStatus.classList.remove('active');
            }
        }
        
        // ì„¼ì„œ ë°ì´í„° í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateSensorDisplay(data) {
            currentDistance.textContent = data.distance !== null ? data.distance : '--';
            measurementCount.textContent = data.count || 0;
            
            const stats = data.stats;
            avgDistance.textContent = stats.avg_distance !== null ? stats.avg_distance : '--';
            minDistance.textContent = stats.min_distance !== null ? stats.min_distance : '--';
            maxDistance.textContent = stats.max_distance !== null ? stats.max_distance : '--';
        }
        
        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateChart(distance) {
            if (distance !== null) {
                chartData.push(distance);
                if (chartData.length > maxChartPoints) {
                    chartData.shift();
                }
            }
            renderChart();
        }
        
        // ì°¨íŠ¸ ë Œë”ë§
        function renderChart() {
            sensorChart.innerHTML = '';
            
            if (chartData.length === 0) return;
            
            const maxDistance = Math.max(...chartData);
            const chartWidth = sensorChart.clientWidth;
            const chartHeight = sensorChart.clientHeight;
            const barWidth = chartWidth / maxChartPoints;
            
            chartData.forEach((distance, index) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.left = `${index * barWidth}px`;
                bar.style.width = `${barWidth - 2}px`;
                bar.style.height = `${(distance / maxDistance) * chartHeight * 0.8}px`;
                bar.title = `${distance} cm`;
                
                sensorChart.appendChild(bar);
            });
        }
        
        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function clearChart() {
            chartData = [];
            renderChart();
            
            // ì„¼ì„œ ë°ì´í„° ì´ˆê¸°í™”
            currentDistance.textContent = '--';
            measurementCount.textContent = '0';
            avgDistance.textContent = '--';
            minDistance.textContent = '--';
            maxDistance.textContent = '--';
        }
        
        // ëª…ë ¹ ì´ë¦„ ë³€í™˜
        function getCommandName(command) {
            const names = {
                'forward': 'ì „ì§„',
                'backward': 'í›„ì§„',
                'left': 'ì¢ŒíšŒì „',
                'right': 'ìš°íšŒì „',
                'forward-left': 'ì™¼ìª½ ì•ìœ¼ë¡œ',
                'forward-right': 'ì˜¤ë¥¸ìª½ ì•ìœ¼ë¡œ',
                'backward-left': 'ì™¼ìª½ ë’¤ë¡œ',
                'backward-right': 'ì˜¤ë¥¸ìª½ ë’¤ë¡œ',
                'stop': 'ì •ì§€'
            };
            return names[command] || command;
        }
        
        // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
        function updateTimestamp() {
            const now = new Date();
            const timestamp = document.getElementById('timestamp');
            if (timestamp) {
                timestamp.textContent = now.toLocaleTimeString('ko-KR');
            }
        }
        
        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type = 'system') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            systemLog.insertBefore(logEntry, systemLog.firstChild);
            
            // ë¡œê·¸ ê°œìˆ˜ ì œí•œ (ìµœëŒ€ 50ê°œ)
            while (systemLog.children.length > 50) {
                systemLog.removeChild(systemLog.lastChild);
            }
        }
        
        // ìŠ¤íŠ¸ë¦¼ ì—ëŸ¬ ì²˜ë¦¬
        document.getElementById('cameraStream').onerror = function() {
            addLog('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹¤íŒ¨', 'error');
        };
        
        // ìŠ¤íŠ¸ë¦¼ ë¡œë“œ ì™„ë£Œ
        document.getElementById('cameraStream').onload = function() {
            addLog('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì—°ê²°ë¨', 'system');
        };
        
        // í˜ì´ì§€ ë– ë‚  ë•Œ ì •ì§€
        window.addEventListener('beforeunload', () => {
            if (activeCommand && isConnected) {
                socket.emit('motor_command', { command: 'stop', speed: 0 });
            }
        });
        
        // ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ ì²˜ë¦¬
        window.addEventListener('resize', () => {
            setTimeout(renderChart, 100);
        });
    </script>
</body>
</html> 