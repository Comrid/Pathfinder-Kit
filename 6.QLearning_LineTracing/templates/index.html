<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§  Q-Learning LineTracing | íŒ¨ìŠ¤íŒŒì¸ë” í‚¤íŠ¸</title>
    
    <!-- CSS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #16a34a;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--success-color));
            color: white;
            border-radius: 15px;
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--primary-color);
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .video-stream {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-custom {
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-learning {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
        }

        .btn-autonomous {
            background: linear-gradient(135deg, #16a34a, #15803d);
            border: none;
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: none;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .q-table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .q-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .q-table th,
        .q-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            font-size: 0.8rem;
        }

        .q-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .q-value {
            border-radius: 4px;
            padding: 4px;
            color: white;
            font-weight: 500;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .learning-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .autonomous-info {
            background: #f0fdf4;
            border: 1px solid #16a34a;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .action-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 2px;
        }

        .action-0 { background: #fef3c7; color: #92400e; } /* ì¢ŒíšŒì „ */
        .action-1 { background: #ddd6fe; color: #6b21a8; } /* ì•½ê°„ì¢Œ */
        .action-2 { background: #dcfce7; color: #166534; } /* ì§ì§„ */
        .action-3 { background: #fed7d7; color: #c53030; } /* ì•½ê°„ìš° */
        .action-4 { background: #fecaca; color: #991b1b; } /* ìš°íšŒì „ */

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #16a34a; }
        .status-offline { background: #dc2626; }
        .status-learning { background: #d97706; }

        .log-container {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            margin-bottom: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #9ca3af;
        }

        .processed-frame {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn-custom {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- í—¤ë” -->
            <div class="header">
                <h1><i class="fas fa-brain"></i> Q-Learning LineTracing</h1>
                <p class="mb-0">íŒ¨ìŠ¤íŒŒì¸ë” í‚¤íŠ¸ ê°•í™”í•™ìŠµ ììœ¨ì£¼í–‰ ì‹œìŠ¤í…œ</p>
            </div>

            <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
            <div class="status-card">
                <h5><i class="fas fa-info-circle"></i> ì‹œìŠ¤í…œ ìƒíƒœ</h5>
                <div class="row">
                    <div class="col-md-3">
                        <span class="status-indicator" id="gpio-status"></span>
                        <span id="gpio-text">GPIO: í™•ì¸ ì¤‘...</span>
                    </div>
                    <div class="col-md-3">
                        <span class="status-indicator" id="camera-status"></span>
                        <span id="camera-text">ì¹´ë©”ë¼: í™•ì¸ ì¤‘...</span>
                    </div>
                    <div class="col-md-3">
                        <span class="status-indicator" id="learning-status"></span>
                        <span id="learning-text">í•™ìŠµ: ëŒ€ê¸° ì¤‘</span>
                    </div>
                    <div class="col-md-3">
                        <span class="status-indicator" id="autonomous-status"></span>
                        <span id="autonomous-text">ììœ¨ì£¼í–‰: ëŒ€ê¸° ì¤‘</span>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- ì™¼ìª½ ì»¬ëŸ¼: ì¹´ë©”ë¼ ë° ì œì–´ -->
                <div class="col-lg-6">
                    <!-- ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë° -->
                    <div class="video-container">
                        <img src="/video_feed" class="video-stream" alt="ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë°">
                        <div class="video-overlay">
                            <div>ì‹¤ì‹œê°„ ì¹´ë©”ë¼</div>
                            <div id="fps-counter">FPS: --</div>
                        </div>
                    </div>

                    <!-- ì²˜ë¦¬ëœ í”„ë ˆì„ -->
                    <div class="video-container" id="processed-container" style="display: none;">
                        <img id="processed-frame" class="processed-frame" alt="ì²˜ë¦¬ëœ í”„ë ˆì„">
                        <div class="video-overlay">
                            <div>ë¼ì¸ ê²€ì¶œ ê²°ê³¼</div>
                        </div>
                    </div>

                    <!-- ì œì–´ íŒ¨ë„ -->
                    <div class="control-panel">
                        <h5><i class="fas fa-gamepad"></i> ì œì–´ íŒ¨ë„</h5>
                        
                        <!-- Q-Learning ì œì–´ -->
                        <div class="mb-3">
                            <h6>Q-Learning í•™ìŠµ</h6>
                            <button class="btn btn-learning btn-custom" id="start-learning">
                                <i class="fas fa-play"></i> í•™ìŠµ ì‹œì‘
                            </button>
                            <button class="btn btn-stop btn-custom" id="stop-learning">
                                <i class="fas fa-stop"></i> í•™ìŠµ ì¤‘ì§€
                            </button>
                            <button class="btn btn-secondary btn-custom" id="reset-learning">
                                <i class="fas fa-redo"></i> í•™ìŠµ ì´ˆê¸°í™”
                            </button>
                        </div>

                        <!-- ììœ¨ì£¼í–‰ ì œì–´ -->
                        <div class="mb-3">
                            <h6>ììœ¨ì£¼í–‰</h6>
                            <button class="btn btn-autonomous btn-custom" id="start-autonomous">
                                <i class="fas fa-robot"></i> ììœ¨ì£¼í–‰ ì‹œì‘
                            </button>
                            <button class="btn btn-stop btn-custom" id="stop-autonomous">
                                <i class="fas fa-stop"></i> ììœ¨ì£¼í–‰ ì¤‘ì§€
                            </button>
                        </div>

                        <!-- ìˆ˜ë™ ì œì–´ -->
                        <div class="mb-3">
                            <h6>ìˆ˜ë™ ì œì–´</h6>
                            <div class="text-center">
                                <div>
                                    <button class="btn btn-outline-primary btn-custom" id="manual-forward">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-outline-primary btn-custom" id="manual-left">
                                        <i class="fas fa-arrow-left"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-custom" id="manual-stop">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                    <button class="btn btn-outline-primary btn-custom" id="manual-right">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ëª¨ë¸ ê´€ë¦¬ -->
                        <div class="mb-3">
                            <h6>ëª¨ë¸ ê´€ë¦¬</h6>
                            <button class="btn btn-success btn-custom" id="save-model">
                                <i class="fas fa-save"></i> ëª¨ë¸ ì €ì¥
                            </button>
                            <button class="btn btn-info btn-custom" id="load-model">
                                <i class="fas fa-upload"></i> ëª¨ë¸ ë¡œë“œ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½ ì»¬ëŸ¼: í•™ìŠµ ì •ë³´ ë° í†µê³„ -->
                <div class="col-lg-6">
                    <!-- ì‹¤ì‹œê°„ í†µê³„ -->
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="episode-count">0</div>
                            <div class="stat-label">ì—í”¼ì†Œë“œ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-steps">0</div>
                            <div class="stat-label">ì´ ìŠ¤í…</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="success-rate">0%</div>
                            <div class="stat-label">ì„±ê³µë¥ </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="epsilon-value">0.30</div>
                            <div class="stat-label">íƒí—˜ë¥  (Îµ)</div>
                        </div>
                    </div>

                    <!-- í•™ìŠµ ì •ë³´ -->
                    <div id="learning-info" class="learning-info" style="display: none;">
                        <h6><i class="fas fa-brain"></i> í•™ìŠµ ì§„í–‰ ìƒí™©</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>í˜„ì¬ ìƒíƒœ:</strong> <span id="current-state">-</span><br>
                                <strong>ì„ íƒëœ í–‰ë™:</strong> <span id="current-action">-</span><br>
                                <strong>ë³´ìƒ:</strong> <span id="current-reward">-</span>
                            </div>
                            <div class="col-6">
                                <strong>ì—í”¼ì†Œë“œ ë³´ìƒ:</strong> <span id="episode-reward">0</span><br>
                                <strong>ë¼ì¸ ê²€ì¶œ:</strong> <span id="line-detected">-</span><br>
                                <strong>ë¼ì¸ ìœ„ì¹˜:</strong> <span id="line-position">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- ììœ¨ì£¼í–‰ ì •ë³´ -->
                    <div id="autonomous-info" class="autonomous-info" style="display: none;">
                        <h6><i class="fas fa-robot"></i> ììœ¨ì£¼í–‰ ìƒíƒœ</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>í˜„ì¬ ìƒíƒœ:</strong> <span id="auto-state">-</span><br>
                                <strong>ì„ íƒëœ í–‰ë™:</strong> <span id="auto-action">-</span><br>
                                <strong>ì‹ ë¢°ë„:</strong> <span id="auto-confidence">-</span>
                            </div>
                            <div class="col-6">
                                <strong>ë¼ì¸ ê²€ì¶œ:</strong> <span id="auto-line-detected">-</span><br>
                                <strong>ë¼ì¸ ìœ„ì¹˜:</strong> <span id="auto-line-position">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Q-í…Œì´ë¸” íˆíŠ¸ë§µ -->
                    <div class="q-table-container">
                        <h5><i class="fas fa-table"></i> Q-í…Œì´ë¸” íˆíŠ¸ë§µ</h5>
                        <p class="text-muted">ê° ìƒíƒœì—ì„œì˜ í–‰ë™ ê°€ì¹˜ í•¨ìˆ˜</p>
                        <div id="q-table-display">
                            <table class="q-table">
                                <thead>
                                    <tr>
                                        <th>ìƒíƒœ\í–‰ë™</th>
                                        <th>ì¢ŒíšŒì „</th>
                                        <th>ì•½ê°„ì¢Œ</th>
                                        <th>ì§ì§„</th>
                                        <th>ì•½ê°„ìš°</th>
                                        <th>ìš°íšŒì „</th>
                                    </tr>
                                </thead>
                                <tbody id="q-table-body">
                                    <!-- Q-í…Œì´ë¸” ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- í•™ìŠµ ì°¨íŠ¸ -->
                    <div class="chart-container">
                        <h5><i class="fas fa-chart-line"></i> í•™ìŠµ ì§„í–‰ ì°¨íŠ¸</h5>
                        <canvas id="reward-chart" width="400" height="200"></canvas>
                    </div>

                    <!-- ì‹œìŠ¤í…œ ë¡œê·¸ -->
                    <div class="log-container" id="system-log">
                        <div class="log-entry">
                            <span class="log-timestamp">[ì‹œì‘]</span> ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Socket.IO ì—°ê²°
        const socket = io();
        
        // ì „ì—­ ë³€ìˆ˜
        let rewardChart = null;
        let isLearning = false;
        let isAutonomous = false;
        let frameCount = 0;
        let lastFpsTime = Date.now();

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            setupEventListeners();
            updateSystemStatus();
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸
            setInterval(updateSystemStatus, 5000);
            setInterval(updateFPS, 1000);
        });

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initializeChart() {
            const ctx = document.getElementById('reward-chart').getContext('2d');
            rewardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì—í”¼ì†Œë“œ ë³´ìƒ',
                        data: [],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // í•™ìŠµ ì œì–´
            document.getElementById('start-learning').addEventListener('click', () => {
                socket.emit('start_learning');
            });

            document.getElementById('stop-learning').addEventListener('click', () => {
                socket.emit('stop_learning');
            });

            document.getElementById('reset-learning').addEventListener('click', () => {
                if (confirm('í•™ìŠµ ë°ì´í„°ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    socket.emit('reset_learning');
                }
            });

            // ììœ¨ì£¼í–‰ ì œì–´
            document.getElementById('start-autonomous').addEventListener('click', () => {
                socket.emit('start_autonomous');
            });

            document.getElementById('stop-autonomous').addEventListener('click', () => {
                socket.emit('stop_autonomous');
            });

            // ìˆ˜ë™ ì œì–´
            document.getElementById('manual-forward').addEventListener('click', () => {
                socket.emit('manual_control', {command: 'forward'});
            });

            document.getElementById('manual-left').addEventListener('click', () => {
                socket.emit('manual_control', {command: 'left'});
            });

            document.getElementById('manual-right').addEventListener('click', () => {
                socket.emit('manual_control', {command: 'right'});
            });

            document.getElementById('manual-stop').addEventListener('click', () => {
                socket.emit('manual_control', {command: 'stop'});
            });

            // ëª¨ë¸ ê´€ë¦¬
            document.getElementById('save-model').addEventListener('click', () => {
                socket.emit('save_model');
            });

            document.getElementById('load-model').addEventListener('click', () => {
                const filename = prompt('ë¡œë“œí•  ëª¨ë¸ íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', 'q_learning_model.json');
                if (filename) {
                    socket.emit('load_model', {filename: filename});
                }
            });
        }

        // ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSystemStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // GPIO ìƒíƒœ
                    const gpioStatus = document.getElementById('gpio-status');
                    const gpioText = document.getElementById('gpio-text');
                    if (data.gpio_available) {
                        gpioStatus.className = 'status-indicator status-online';
                        gpioText.textContent = 'GPIO: ì—°ê²°ë¨';
                    } else {
                        gpioStatus.className = 'status-indicator status-offline';
                        gpioText.textContent = 'GPIO: ì‹œë®¬ë ˆì´ì…˜';
                    }

                    // ì¹´ë©”ë¼ ìƒíƒœ
                    const cameraStatus = document.getElementById('camera-status');
                    const cameraText = document.getElementById('camera-text');
                    if (data.camera_available) {
                        cameraStatus.className = 'status-indicator status-online';
                        cameraText.textContent = 'ì¹´ë©”ë¼: ì—°ê²°ë¨';
                    } else {
                        cameraStatus.className = 'status-indicator status-offline';
                        cameraText.textContent = 'ì¹´ë©”ë¼: ì‹œë®¬ë ˆì´ì…˜';
                    }

                    // í•™ìŠµ ìƒíƒœ
                    const learningStatus = document.getElementById('learning-status');
                    const learningText = document.getElementById('learning-text');
                    if (data.learning_active) {
                        learningStatus.className = 'status-indicator status-learning';
                        learningText.textContent = 'í•™ìŠµ: ì§„í–‰ ì¤‘';
                        isLearning = true;
                    } else {
                        learningStatus.className = 'status-indicator status-offline';
                        learningText.textContent = 'í•™ìŠµ: ëŒ€ê¸° ì¤‘';
                        isLearning = false;
                    }

                    // ììœ¨ì£¼í–‰ ìƒíƒœ
                    const autonomousStatus = document.getElementById('autonomous-status');
                    const autonomousText = document.getElementById('autonomous-text');
                    if (data.autonomous_mode) {
                        autonomousStatus.className = 'status-indicator status-online';
                        autonomousText.textContent = 'ììœ¨ì£¼í–‰: ì§„í–‰ ì¤‘';
                        isAutonomous = true;
                    } else {
                        autonomousStatus.className = 'status-indicator status-offline';
                        autonomousText.textContent = 'ììœ¨ì£¼í–‰: ëŒ€ê¸° ì¤‘';
                        isAutonomous = false;
                    }

                    // í†µê³„ ì—…ë°ì´íŠ¸
                    document.getElementById('episode-count').textContent = data.episode || 0;
                    document.getElementById('total-steps').textContent = data.total_steps || 0;
                    document.getElementById('success-rate').textContent = (data.success_rate || 0).toFixed(1) + '%';
                    document.getElementById('epsilon-value').textContent = (data.epsilon || 0).toFixed(3);
                })
                .catch(error => {
                    console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                });

            // Q-í…Œì´ë¸” ì—…ë°ì´íŠ¸
            updateQTable();
        }

        // Q-í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateQTable() {
            fetch('/api/q_table')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('q-table-body');
                    tbody.innerHTML = '';

                    for (let state = 0; state < data.states; state++) {
                        const row = document.createElement('tr');
                        
                        // ìƒíƒœ ì—´
                        const stateCell = document.createElement('td');
                        stateCell.textContent = `ìƒíƒœ ${state}`;
                        stateCell.style.fontWeight = 'bold';
                        row.appendChild(stateCell);

                        // ê° í–‰ë™ì˜ Qê°’
                        for (let action = 0; action < data.actions; action++) {
                            const cell = document.createElement('td');
                            const qValue = data.q_table[state][action];
                            
                            const qDiv = document.createElement('div');
                            qDiv.className = 'q-value';
                            qDiv.textContent = qValue.toFixed(2);
                            
                            // Qê°’ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
                            const intensity = Math.min(Math.abs(qValue) / 10, 1);
                            if (qValue > 0) {
                                qDiv.style.backgroundColor = `rgba(34, 197, 94, ${intensity})`;
                            } else if (qValue < 0) {
                                qDiv.style.backgroundColor = `rgba(239, 68, 68, ${intensity})`;
                            } else {
                                qDiv.style.backgroundColor = '#e5e7eb';
                                qDiv.style.color = '#374151';
                            }
                            
                            cell.appendChild(qDiv);
                            row.appendChild(cell);
                        }
                        
                        tbody.appendChild(row);
                    }
                })
                .catch(error => {
                    console.error('Q-í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                });
        }

        // FPS ì¹´ìš´í„° ì—…ë°ì´íŠ¸
        function updateFPS() {
            const now = Date.now();
            const fps = Math.round(frameCount * 1000 / (now - lastFpsTime));
            document.getElementById('fps-counter').textContent = `FPS: ${fps}`;
            frameCount = 0;
            lastFpsTime = now;
        }

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('system-log');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // ë¡œê·¸ ê°œìˆ˜ ì œí•œ (ìµœëŒ€ 100ê°œ)
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // í–‰ë™ ì´ë¦„ ë³€í™˜
        function getActionName(action) {
            const actions = ['ì¢ŒíšŒì „', 'ì•½ê°„ì¢Œ', 'ì§ì§„', 'ì•½ê°„ìš°', 'ìš°íšŒì „'];
            return actions[action] || 'ì•Œ ìˆ˜ ì—†ìŒ';
        }

        // í–‰ë™ í‘œì‹œê¸° ìƒì„±
        function createActionIndicator(action, actionName) {
            return `<span class="action-indicator action-${action}">${actionName}</span>`;
        }

        // Socket.IO ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        socket.on('connect', function() {
            addLog('ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        });

        socket.on('disconnect', function() {
            addLog('ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.', 'error');
        });

        socket.on('system_status', function(data) {
            addLog(`ì‹œìŠ¤í…œ ìƒíƒœ: GPIO=${data.gpio_available}, ì¹´ë©”ë¼=${data.camera_available}`);
        });

        socket.on('learning_started', function(data) {
            addLog(data.message, 'success');
            document.getElementById('learning-info').style.display = 'block';
            document.getElementById('autonomous-info').style.display = 'none';
        });

        socket.on('learning_stopped', function(data) {
            addLog(data.message, 'warning');
            document.getElementById('learning-info').style.display = 'none';
        });

        socket.on('autonomous_started', function(data) {
            addLog(data.message, 'success');
            document.getElementById('autonomous-info').style.display = 'block';
            document.getElementById('learning-info').style.display = 'none';
        });

        socket.on('autonomous_stopped', function(data) {
            addLog(data.message, 'warning');
            document.getElementById('autonomous-info').style.display = 'none';
        });

        socket.on('learning_update', function(data) {
            // í•™ìŠµ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('current-state').textContent = data.state;
            document.getElementById('current-action').innerHTML = createActionIndicator(data.action, data.action_name);
            document.getElementById('current-reward').textContent = data.reward.toFixed(1);
            document.getElementById('episode-reward').textContent = data.total_reward.toFixed(1);
            document.getElementById('line-detected').textContent = data.line_detected ? 'âœ… ê²€ì¶œë¨' : 'âŒ ê²€ì¶œ ì•ˆë¨';
            document.getElementById('line-position').textContent = data.line_center_x || 'N/A';
            
            frameCount++;
        });

        socket.on('autonomous_update', function(data) {
            // ììœ¨ì£¼í–‰ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('auto-state').textContent = data.state;
            document.getElementById('auto-action').innerHTML = createActionIndicator(data.action, data.action_name);
            document.getElementById('auto-confidence').textContent = data.confidence.toFixed(2);
            document.getElementById('auto-line-detected').textContent = data.line_detected ? 'âœ… ê²€ì¶œë¨' : 'âŒ ê²€ì¶œ ì•ˆë¨';
            document.getElementById('auto-line-position').textContent = data.line_center_x || 'N/A';
            
            frameCount++;
        });

        socket.on('episode_complete', function(data) {
            addLog(`ì—í”¼ì†Œë“œ ${data.episode} ì™„ë£Œ: ë³´ìƒ=${data.total_reward.toFixed(1)}, ìŠ¤í…=${data.steps}, ì„±ê³µë¥ =${data.success_rate.toFixed(1)}%`);
            
            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            if (rewardChart) {
                rewardChart.data.labels.push(data.episode);
                rewardChart.data.datasets[0].data.push(data.total_reward);
                
                // ìµœëŒ€ 50ê°œ ë°ì´í„°í¬ì¸íŠ¸ë§Œ ìœ ì§€
                if (rewardChart.data.labels.length > 50) {
                    rewardChart.data.labels.shift();
                    rewardChart.data.datasets[0].data.shift();
                }
                
                rewardChart.update();
            }
        });

        socket.on('processed_frame', function(data) {
            const processedFrame = document.getElementById('processed-frame');
            const container = document.getElementById('processed-container');
            
            processedFrame.src = 'data:image/jpeg;base64,' + data.image;
            container.style.display = 'block';
        });

        socket.on('model_saved', function(data) {
            addLog(data.message, 'success');
        });

        socket.on('model_loaded', function(data) {
            addLog(data.message, 'success');
            updateSystemStatus(); // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
        });

        socket.on('learning_reset', function(data) {
            addLog(data.message, 'warning');
            
            // ì°¨íŠ¸ ì´ˆê¸°í™”
            if (rewardChart) {
                rewardChart.data.labels = [];
                rewardChart.data.datasets[0].data = [];
                rewardChart.update();
            }
            
            updateSystemStatus(); // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
        });

        socket.on('error', function(data) {
            addLog(`ì˜¤ë¥˜: ${data.message}`, 'error');
            alert(data.message);
        });

        socket.on('manual_executed', function(data) {
            addLog(`ìˆ˜ë™ ì œì–´: ${data.command}`);
        });
    </script>
</body>
</html>
