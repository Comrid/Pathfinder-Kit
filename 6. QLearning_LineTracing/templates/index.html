<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Q-Learning LineTracing | Ìå®Ïä§ÌååÏù∏Îçî ÌÇ§Ìä∏</title>
    
    <!-- CSS ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #16a34a;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--success-color));
            color: white;
            border-radius: 15px;
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--primary-color);
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .video-stream {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-custom {
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-learning {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
        }

        .btn-autonomous {
            background: linear-gradient(135deg, #16a34a, #15803d);
            border: none;
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: none;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .q-table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .q-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .q-table th,
        .q-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            font-size: 0.8rem;
        }

        .q-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .q-value {
            border-radius: 4px;
            padding: 4px;
            color: white;
            font-weight: 500;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .learning-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .autonomous-info {
            background: #f0fdf4;
            border: 1px solid #16a34a;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .action-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 2px;
        }

        .action-0 { background: #fef3c7; color: #92400e; } /* Ï¢åÌöåÏ†Ñ */
        .action-1 { background: #ddd6fe; color: #6b21a8; } /* ÏïΩÍ∞ÑÏ¢å */
        .action-2 { background: #dcfce7; color: #166534; } /* ÏßÅÏßÑ */
        .action-3 { background: #fed7d7; color: #c53030; } /* ÏïΩÍ∞ÑÏö∞ */
        .action-4 { background: #fecaca; color: #991b1b; } /* Ïö∞ÌöåÏ†Ñ */

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #16a34a; }
        .status-offline { background: #dc2626; }
        .status-learning { background: #d97706; }

        .log-container {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            margin-bottom: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #9ca3af;
        }

        .processed-frame {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn-custom {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Ìó§Îçî -->
            <div class="header">
                <h1><i class="fas fa-brain"></i> Q-Learning LineTracing</h1>
                <p class="mb-0">Ìå®Ïä§ÌååÏù∏Îçî ÌÇ§Ìä∏ Í∞ïÌôîÌïôÏäµ ÏûêÏú®Ï£ºÌñâ ÏãúÏä§ÌÖú</p>
            </div>

            <!-- ÏãúÏä§ÌÖú ÏÉÅÌÉú -->
            <div class="status-card">
                <h5><i class="fas fa-info-circle"></i> ÏãúÏä§ÌÖú ÏÉÅÌÉú</h5>
                <div class="row">
                    <div class="col-md-3">
                        <span class="status-indicator" id="gpio-status"></span>
                        <span id="gpio-text">GPIO: ÌôïÏù∏ Ï§ë...</span>
                    </div>
                    <div class="col-md-3">
                        <span class="status-indicator" id="camera-status"></span>
                        <span id="camera-text">Ïπ¥Î©îÎùº: ÌôïÏù∏ Ï§ë...</span>
                    </div>
                    <div class="col-md-3">
                        <span class="status-indicator" id="learning-status"></span>
                        <span id="learning-text">ÌïôÏäµ: ÎåÄÍ∏∞ Ï§ë</span>
                    </div>
                    <div class="col-md-3">
                        <span class="status-indicator" id="autonomous-status"></span>
                        <span id="autonomous-text">ÏûêÏú®Ï£ºÌñâ: ÎåÄÍ∏∞ Ï§ë</span>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- ÏôºÏ™Ω Ïª¨Îüº: Ïπ¥Î©îÎùº Î∞è Ï†úÏñ¥ -->
                <div class="col-lg-6">
                    <!-- Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶¨Î∞ç -->
                    <div class="video-container">
                        <img src="/video_feed" class="video-stream" alt="Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶¨Î∞ç">
                        <div class="video-overlay">
                            <div>Ïã§ÏãúÍ∞Ñ Ïπ¥Î©îÎùº</div>
                            <div id="fps-counter">FPS: --</div>
                        </div>
                    </div>

                    <!-- Ï≤òÎ¶¨Îêú ÌîÑÎ†àÏûÑ -->
                    <div class="video-container" id="processed-container" style="display: none;">
                        <img id="processed-frame" class="processed-frame" alt="Ï≤òÎ¶¨Îêú ÌîÑÎ†àÏûÑ">
                        <div class="video-overlay">
                            <div>ÎùºÏù∏ Í≤ÄÏ∂ú Í≤∞Í≥º</div>
                        </div>
                    </div>

                    <!-- Ï†úÏñ¥ Ìå®ÎÑê -->
                    <div class="control-panel">
                        <h5><i class="fas fa-gamepad"></i> Ï†úÏñ¥ Ìå®ÎÑê</h5>
                        
                        <!-- Q-Learning Ï†úÏñ¥ -->
                        <div class="mb-3">
                            <h6>Q-Learning ÌïôÏäµ</h6>
                            <button class="btn btn-learning btn-custom" id="start-learning">
                                <i class="fas fa-play"></i> ÌïôÏäµ ÏãúÏûë
                            </button>
                            <button class="btn btn-stop btn-custom" id="stop-learning">
                                <i class="fas fa-stop"></i> ÌïôÏäµ Ï§ëÏßÄ
                            </button>
                            <button class="btn btn-secondary btn-custom" id="reset-learning">
                                <i class="fas fa-redo"></i> ÌïôÏäµ Ï¥àÍ∏∞Ìôî
                            </button>
                        </div>

                        <!-- ÏûêÏú®Ï£ºÌñâ Ï†úÏñ¥ -->
                        <div class="mb-3">
                            <h6>ÏûêÏú®Ï£ºÌñâ</h6>
                            <button class="btn btn-autonomous btn-custom" id="start-autonomous">
                                <i class="fas fa-robot"></i> ÏûêÏú®Ï£ºÌñâ ÏãúÏûë
                            </button>
                            <button class="btn btn-stop btn-custom" id="stop-autonomous">
                                <i class="fas fa-stop"></i> ÏûêÏú®Ï£ºÌñâ Ï§ëÏßÄ
                            </button>
                        </div>

                        <!-- ÏàòÎèô Ï†úÏñ¥ -->
                        <div class="mb-3">
                            <h6>ÏàòÎèô Ï†úÏñ¥</h6>
                            <div class="text-center">
                                <div>
                                    <button class="btn btn-outline-primary btn-custom" id="manual-forward">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-outline-primary btn-custom" id="manual-left">
                                        <i class="fas fa-arrow-left"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-custom" id="manual-stop">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                    <button class="btn btn-outline-primary btn-custom" id="manual-right">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Î™®Îç∏ Í¥ÄÎ¶¨ -->
                        <div class="mb-3">
                            <h6>Î™®Îç∏ Í¥ÄÎ¶¨</h6>
                            <button class="btn btn-success btn-custom" id="save-model">
                                <i class="fas fa-save"></i> Î™®Îç∏ Ï†ÄÏû•
                            </button>
                            <button class="btn btn-info btn-custom" id="load-model">
                                <i class="fas fa-upload"></i> Î™®Îç∏ Î°úÎìú
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ïò§Î•∏Ï™Ω Ïª¨Îüº: ÌïôÏäµ Ï†ïÎ≥¥ Î∞è ÌÜµÍ≥Ñ -->
                <div class="col-lg-6">
                    <!-- Ïã§ÏãúÍ∞Ñ ÌÜµÍ≥Ñ -->
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="episode-count">0</div>
                            <div class="stat-label">ÏóêÌîºÏÜåÎìú</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-steps">0</div>
                            <div class="stat-label">Ï¥ù Ïä§ÌÖù</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="success-rate">0%</div>
                            <div class="stat-label">ÏÑ±Í≥µÎ•†</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="epsilon-value">0.30</div>
                            <div class="stat-label">ÌÉêÌóòÎ•† (Œµ)</div>
                        </div>
                    </div>

                    <!-- ÌïôÏäµ Ï†ïÎ≥¥ -->
                    <div id="learning-info" class="learning-info" style="display: none;">
                        <h6><i class="fas fa-brain"></i> ÌïôÏäµ ÏßÑÌñâ ÏÉÅÌô©</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>ÌòÑÏû¨ ÏÉÅÌÉú:</strong> <span id="current-state">-</span><br>
                                <strong>ÏÑ†ÌÉùÎêú ÌñâÎèô:</strong> <span id="current-action">-</span><br>
                                <strong>Î≥¥ÏÉÅ:</strong> <span id="current-reward">-</span>
                            </div>
                            <div class="col-6">
                                <strong>ÏóêÌîºÏÜåÎìú Î≥¥ÏÉÅ:</strong> <span id="episode-reward">0</span><br>
                                <strong>ÎùºÏù∏ Í≤ÄÏ∂ú:</strong> <span id="line-detected">-</span><br>
                                <strong>ÎùºÏù∏ ÏúÑÏπò:</strong> <span id="line-position">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- ÏûêÏú®Ï£ºÌñâ Ï†ïÎ≥¥ -->
                    <div id="autonomous-info" class="autonomous-info" style="display: none;">
                        <h6><i class="fas fa-robot"></i> ÏûêÏú®Ï£ºÌñâ ÏÉÅÌÉú</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>ÌòÑÏû¨ ÏÉÅÌÉú:</strong> <span id="auto-state">-</span><br>
                                <strong>ÏÑ†ÌÉùÎêú ÌñâÎèô:</strong> <span id="auto-action">-</span><br>
                                <strong>Ïã†Î¢∞ÎèÑ:</strong> <span id="auto-confidence">-</span>
                            </div>
                            <div class="col-6">
                                <strong>ÎùºÏù∏ Í≤ÄÏ∂ú:</strong> <span id="auto-line-detected">-</span><br>
                                <strong>ÎùºÏù∏ ÏúÑÏπò:</strong> <span id="auto-line-position">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Q-ÌÖåÏù¥Î∏î ÌûàÌä∏Îßµ -->
                    <div class="q-table-container">
                        <h5><i class="fas fa-table"></i> Q-ÌÖåÏù¥Î∏î ÌûàÌä∏Îßµ</h5>
                        <p class="text-muted">Í∞Å ÏÉÅÌÉúÏóêÏÑúÏùò ÌñâÎèô Í∞ÄÏπò Ìï®Ïàò</p>
                        <div id="q-table-display">
                            <table class="q-table">
                                <thead>
                                    <tr>
                                        <th>ÏÉÅÌÉú\ÌñâÎèô</th>
                                        <th>Ï¢åÌöåÏ†Ñ</th>
                                        <th>ÏïΩÍ∞ÑÏ¢å</th>
                                        <th>ÏßÅÏßÑ</th>
                                        <th>ÏïΩÍ∞ÑÏö∞</th>
                                        <th>Ïö∞ÌöåÏ†Ñ</th>
                                    </tr>
                                </thead>
                                <tbody id="q-table-body">
                                    <!-- Q-ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞Í∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ÌïôÏäµ Ï∞®Ìä∏ -->
                    <div class="chart-container">
                        <h5><i class="fas fa-chart-line"></i> ÌïôÏäµ ÏßÑÌñâ Ï∞®Ìä∏</h5>
                        <canvas id="reward-chart" width="400" height="200"></canvas>
                    </div>

                    <!-- ÏãúÏä§ÌÖú Î°úÍ∑∏ -->
                    <div class="log-container" id="system-log">
                        <div class="log-entry">
                            <span class="log-timestamp">[ÏãúÏûë]</span> ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï§ë...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Socket.IO Ïó∞Í≤∞
        const socket = io();
        
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let rewardChart = null;
        let isLearning = false;
        let isAutonomous = false;
        let frameCount = 0;
        let lastFpsTime = Date.now();

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            setupEventListeners();
            updateSystemStatus();
            
            // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            setInterval(updateSystemStatus, 5000);
            setInterval(updateFPS, 1000);
        });

        // Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
        function initializeChart() {
            const ctx = document.getElementById('reward-chart').getContext('2d');
            rewardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ÏóêÌîºÏÜåÎìú Î≥¥ÏÉÅ',
                        data: [],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners() {
            // ÌïôÏäµ Ï†úÏñ¥
            document.getElementById('start-learning').addEventListener('click', () => {
                socket.emit('start_learning');
            });

            document.getElementById('stop-learning').addEventListener('click', () => {
                socket.emit('stop_learning');
            });

            document.getElementById('reset-learning').addEventListener('click', () => {
                if (confirm('ÌïôÏäµ Îç∞Ïù¥ÌÑ∞Î•º Î™®Îëê Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    socket.emit('reset_learning');
                }
            });

            // ÏûêÏú®Ï£ºÌñâ Ï†úÏñ¥
            document.getElementById('start-autonomous').addEventListener('click', () => {
                socket.emit('start_autonomous');
            });

            document.getElementById('stop-autonomous').addEventListener('click', () => {
                socket.emit('stop_autonomous');
            });

            // ÏàòÎèô Ï†úÏñ¥
            document.getElementById('manual-forward').addEventListener('click', () => {
                socket.emit('manual_control', {command: 'forward'});
            });

            document.getElementById('manual-left').addEventListener('click', () => {
                socket.emit('manual_control', {command: 'left'});
            });

            document.getElementById('manual-right').addEventListener('click', () => {
                socket.emit('manual_control', {command: 'right'});
            });

            document.getElementById('manual-stop').addEventListener('click', () => {
                socket.emit('manual_control', {command: 'stop'});
            });

            // Î™®Îç∏ Í¥ÄÎ¶¨
            document.getElementById('save-model').addEventListener('click', () => {
                socket.emit('save_model');
            });

            document.getElementById('load-model').addEventListener('click', () => {
                const filename = prompt('Î°úÎìúÌï† Î™®Îç∏ ÌååÏùºÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', 'q_learning_model.json');
                if (filename) {
                    socket.emit('load_model', {filename: filename});
                }
            });
        }

        // ÏãúÏä§ÌÖú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateSystemStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // GPIO ÏÉÅÌÉú
                    const gpioStatus = document.getElementById('gpio-status');
                    const gpioText = document.getElementById('gpio-text');
                    if (data.gpio_available) {
                        gpioStatus.className = 'status-indicator status-online';
                        gpioText.textContent = 'GPIO: Ïó∞Í≤∞Îê®';
                    } else {
                        gpioStatus.className = 'status-indicator status-offline';
                        gpioText.textContent = 'GPIO: ÏãúÎÆ¨Î†àÏù¥ÏÖò';
                    }

                    // Ïπ¥Î©îÎùº ÏÉÅÌÉú
                    const cameraStatus = document.getElementById('camera-status');
                    const cameraText = document.getElementById('camera-text');
                    if (data.camera_available) {
                        cameraStatus.className = 'status-indicator status-online';
                        cameraText.textContent = 'Ïπ¥Î©îÎùº: Ïó∞Í≤∞Îê®';
                    } else {
                        cameraStatus.className = 'status-indicator status-offline';
                        cameraText.textContent = 'Ïπ¥Î©îÎùº: ÏãúÎÆ¨Î†àÏù¥ÏÖò';
                    }

                    // ÌïôÏäµ ÏÉÅÌÉú
                    const learningStatus = document.getElementById('learning-status');
                    const learningText = document.getElementById('learning-text');
                    if (data.learning_active) {
                        learningStatus.className = 'status-indicator status-learning';
                        learningText.textContent = 'ÌïôÏäµ: ÏßÑÌñâ Ï§ë';
                        isLearning = true;
                    } else {
                        learningStatus.className = 'status-indicator status-offline';
                        learningText.textContent = 'ÌïôÏäµ: ÎåÄÍ∏∞ Ï§ë';
                        isLearning = false;
                    }

                    // ÏûêÏú®Ï£ºÌñâ ÏÉÅÌÉú
                    const autonomousStatus = document.getElementById('autonomous-status');
                    const autonomousText = document.getElementById('autonomous-text');
                    if (data.autonomous_mode) {
                        autonomousStatus.className = 'status-indicator status-online';
                        autonomousText.textContent = 'ÏûêÏú®Ï£ºÌñâ: ÏßÑÌñâ Ï§ë';
                        isAutonomous = true;
                    } else {
                        autonomousStatus.className = 'status-indicator status-offline';
                        autonomousText.textContent = 'ÏûêÏú®Ï£ºÌñâ: ÎåÄÍ∏∞ Ï§ë';
                        isAutonomous = false;
                    }

                    // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('episode-count').textContent = data.episode || 0;
                    document.getElementById('total-steps').textContent = data.total_steps || 0;
                    document.getElementById('success-rate').textContent = (data.success_rate || 0).toFixed(1) + '%';
                    document.getElementById('epsilon-value').textContent = (data.epsilon || 0).toFixed(3);
                })
                .catch(error => {
                    console.error('ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
                });

            // Q-ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
            updateQTable();
        }

        // Q-ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
        function updateQTable() {
            fetch('/api/q_table')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('q-table-body');
                    tbody.innerHTML = '';

                    for (let state = 0; state < data.states; state++) {
                        const row = document.createElement('tr');
                        
                        // ÏÉÅÌÉú Ïó¥
                        const stateCell = document.createElement('td');
                        stateCell.textContent = `ÏÉÅÌÉú ${state}`;
                        stateCell.style.fontWeight = 'bold';
                        row.appendChild(stateCell);

                        // Í∞Å ÌñâÎèôÏùò QÍ∞í
                        for (let action = 0; action < data.actions; action++) {
                            const cell = document.createElement('td');
                            const qValue = data.q_table[state][action];
                            
                            const qDiv = document.createElement('div');
                            qDiv.className = 'q-value';
                            qDiv.textContent = qValue.toFixed(2);
                            
                            // QÍ∞íÏóê Îî∞Î•∏ ÏÉâÏÉÅ ÏÑ§Ï†ï
                            const intensity = Math.min(Math.abs(qValue) / 10, 1);
                            if (qValue > 0) {
                                qDiv.style.backgroundColor = `rgba(34, 197, 94, ${intensity})`;
                            } else if (qValue < 0) {
                                qDiv.style.backgroundColor = `rgba(239, 68, 68, ${intensity})`;
                            } else {
                                qDiv.style.backgroundColor = '#e5e7eb';
                                qDiv.style.color = '#374151';
                            }
                            
                            cell.appendChild(qDiv);
                            row.appendChild(cell);
                        }
                        
                        tbody.appendChild(row);
                    }
                })
                .catch(error => {
                    console.error('Q-ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
                });
        }

        // FPS Ïπ¥Ïö¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateFPS() {
            const now = Date.now();
            const fps = Math.round(frameCount * 1000 / (now - lastFpsTime));
            document.getElementById('fps-counter').textContent = `FPS: ${fps}`;
            frameCount = 0;
            lastFpsTime = now;
        }

        // Î°úÍ∑∏ Ï∂îÍ∞Ä
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('system-log');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Î°úÍ∑∏ Í∞úÏàò Ï†úÌïú (ÏµúÎåÄ 100Í∞ú)
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // ÌñâÎèô Ïù¥Î¶Ñ Î≥ÄÌôò
        function getActionName(action) {
            const actions = ['Ï¢åÌöåÏ†Ñ', 'ÏïΩÍ∞ÑÏ¢å', 'ÏßÅÏßÑ', 'ÏïΩÍ∞ÑÏö∞', 'Ïö∞ÌöåÏ†Ñ'];
            return actions[action] || 'Ïïå Ïàò ÏóÜÏùå';
        }

        // ÌñâÎèô ÌëúÏãúÍ∏∞ ÏÉùÏÑ±
        function createActionIndicator(action, actionName) {
            return `<span class="action-indicator action-${action}">${actionName}</span>`;
        }

        // Socket.IO Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
        socket.on('connect', function() {
            addLog('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.', 'success');
        });

        socket.on('disconnect', function() {
            addLog('ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.', 'error');
        });

        socket.on('system_status', function(data) {
            addLog(`ÏãúÏä§ÌÖú ÏÉÅÌÉú: GPIO=${data.gpio_available}, Ïπ¥Î©îÎùº=${data.camera_available}`);
        });

        socket.on('learning_started', function(data) {
            addLog(data.message, 'success');
            document.getElementById('learning-info').style.display = 'block';
            document.getElementById('autonomous-info').style.display = 'none';
        });

        socket.on('learning_stopped', function(data) {
            addLog(data.message, 'warning');
            document.getElementById('learning-info').style.display = 'none';
        });

        socket.on('autonomous_started', function(data) {
            addLog(data.message, 'success');
            document.getElementById('autonomous-info').style.display = 'block';
            document.getElementById('learning-info').style.display = 'none';
        });

        socket.on('autonomous_stopped', function(data) {
            addLog(data.message, 'warning');
            document.getElementById('autonomous-info').style.display = 'none';
        });

        socket.on('learning_update', function(data) {
            // ÌïôÏäµ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('current-state').textContent = data.state;
            document.getElementById('current-action').innerHTML = createActionIndicator(data.action, data.action_name);
            document.getElementById('current-reward').textContent = data.reward.toFixed(1);
            document.getElementById('episode-reward').textContent = data.total_reward.toFixed(1);
            document.getElementById('line-detected').textContent = data.line_detected ? '‚úÖ Í≤ÄÏ∂úÎê®' : '‚ùå Í≤ÄÏ∂ú ÏïàÎê®';
            document.getElementById('line-position').textContent = data.line_center_x || 'N/A';
            
            frameCount++;
        });

        socket.on('autonomous_update', function(data) {
            // ÏûêÏú®Ï£ºÌñâ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('auto-state').textContent = data.state;
            document.getElementById('auto-action').innerHTML = createActionIndicator(data.action, data.action_name);
            document.getElementById('auto-confidence').textContent = data.confidence.toFixed(2);
            document.getElementById('auto-line-detected').textContent = data.line_detected ? '‚úÖ Í≤ÄÏ∂úÎê®' : '‚ùå Í≤ÄÏ∂ú ÏïàÎê®';
            document.getElementById('auto-line-position').textContent = data.line_center_x || 'N/A';
            
            frameCount++;
        });

        socket.on('episode_complete', function(data) {
            addLog(`ÏóêÌîºÏÜåÎìú ${data.episode} ÏôÑÎ£å: Î≥¥ÏÉÅ=${data.total_reward.toFixed(1)}, Ïä§ÌÖù=${data.steps}, ÏÑ±Í≥µÎ•†=${data.success_rate.toFixed(1)}%`);
            
            // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            if (rewardChart) {
                rewardChart.data.labels.push(data.episode);
                rewardChart.data.datasets[0].data.push(data.total_reward);
                
                // ÏµúÎåÄ 50Í∞ú Îç∞Ïù¥ÌÑ∞Ìè¨Ïù∏Ìä∏Îßå Ïú†ÏßÄ
                if (rewardChart.data.labels.length > 50) {
                    rewardChart.data.labels.shift();
                    rewardChart.data.datasets[0].data.shift();
                }
                
                rewardChart.update();
            }
        });

        socket.on('processed_frame', function(data) {
            const processedFrame = document.getElementById('processed-frame');
            const container = document.getElementById('processed-container');
            
            processedFrame.src = 'data:image/jpeg;base64,' + data.image;
            container.style.display = 'block';
        });

        socket.on('model_saved', function(data) {
            addLog(data.message, 'success');
        });

        socket.on('model_loaded', function(data) {
            addLog(data.message, 'success');
            updateSystemStatus(); // ÏÉÅÌÉú ÏÉàÎ°úÍ≥†Ïπ®
        });

        socket.on('learning_reset', function(data) {
            addLog(data.message, 'warning');
            
            // Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
            if (rewardChart) {
                rewardChart.data.labels = [];
                rewardChart.data.datasets[0].data = [];
                rewardChart.update();
            }
            
            updateSystemStatus(); // ÏÉÅÌÉú ÏÉàÎ°úÍ≥†Ïπ®
        });

        socket.on('error', function(data) {
            addLog(`Ïò§Î•ò: ${data.message}`, 'error');
            alert(data.message);
        });

        socket.on('manual_executed', function(data) {
            addLog(`ÏàòÎèô Ï†úÏñ¥: ${data.command}`);
        });
    </script>
</body>
</html>
