# 🤖 패스파인더 라인 트레이싱 가이드

OpenCV 비전 처리와 PID 제어를 사용한 자율주행 라인 트레이싱 시스템입니다.

## 📋 목차
- [기능 소개](#기능-소개)
- [필요한 준비물](#필요한-준비물)
- [사용법](#사용법)
- [PID 튜닝 가이드](#pid-튜닝-가이드)
- [문제 해결](#문제-해결)

## 🎯 기능 소개

### 핵심 기능
- **실시간 라인 검출**: 흰색 바탕의 검은 선을 OpenCV로 인식
- **PID 제어**: 부드럽고 정확한 라인 추종
- **ROI 처리**: 관심 영역만 처리하여 성능 최적화
- **실시간 디버깅**: 비전 처리 과정과 제어 상태 시각화

### 두 가지 실행 모드
1. **데스크톱 모드** (`line_tracing.py`): OpenCV 창에서 직접 확인
2. **웹 모드** (`line_tracing_web.py`): 브라우저에서 원격 모니터링

## 🛠 필요한 준비물

### 하드웨어
- 조립된 패스파인더 로봇
- 라인 트레이싱 트랙 (흰색 바탕 + 검은 선)
- 충분한 조명

### 소프트웨어
```bash
# 필요한 라이브러리 설치
sudo apt update
sudo apt install python3-opencv
pip install picamera2 flask numpy
```

### 라인 트레이싱 트랙 만들기
- **바탕**: 흰색 종이 또는 흰색 바닥
- **라인**: 검은색 테이프 (폭 2-3cm 권장)
- **코스**: 직선, 곡선, S자 등 다양한 형태

## 🚀 사용법

### 1. 데스크톱 모드 실행

```bash
cd 2.ComponentClass/_3.CameraClass
python line_tracing.py
```

**조작법:**
- `ESC`: 프로그램 종료
- `R`: PID 제어기 리셋
- `+`: 속도 증가 (+5)
- `-`: 속도 감소 (-5)

### 2. 웹 모드 실행

```bash
cd 2.ComponentClass/_3.CameraClass
python line_tracing_web.py
```

브라우저에서 `http://라즈베리파이IP:5000` 접속

**웹 인터페이스 기능:**
- 실시간 비디오 스트리밍
- 라인 트레이싱 시작/정지
- 속도 조절 슬라이더
- PID 파라미터 실시간 조정
- 상태 정보 모니터링

## 🎛 PID 튜닝 가이드

PID 제어기는 라인 추종의 핵심입니다. 각 파라미터의 역할을 이해하고 순서대로 조정하세요.

### PID 파라미터 설명

#### P (비례) 게인 - 현재 오차에 대한 반응
- **역할**: 라인에서 벗어난 정도에 비례하여 조향
- **기본값**: 0.8
- **조정법**:
  - 너무 낮음 → 반응이 느림, 라인을 놓침
  - 너무 높음 → 진동, 불안정한 움직임

#### I (적분) 게인 - 누적 오차 보정
- **역할**: 지속적인 편향 오차 제거
- **기본값**: 0.1
- **조정법**:
  - 너무 낮음 → 한쪽으로 치우침
  - 너무 높음 → 느린 진동, 오버슈트

#### D (미분) 게인 - 변화율 예측
- **역할**: 급격한 변화 억제, 안정성 향상
- **기본값**: 0.3
- **조정법**:
  - 너무 낮음 → 오버슈트, 진동
  - 너무 높음 → 반응이 둔함

### 튜닝 순서

#### 1단계: P 게인 조정
```python
# 초기 설정: I=0, D=0
kp = 0.5  # 시작값
ki = 0.0
kd = 0.0
```
- P 값을 0.1씩 증가시키며 테스트
- 진동 없이 라인을 따라가는 최대값 찾기

#### 2단계: D 게인 추가
```python
kp = 0.8  # 1단계에서 찾은 값
ki = 0.0
kd = 0.1  # 시작값
```
- D 값을 0.05씩 증가시키며 안정성 확인
- 오버슈트가 줄어드는 최적값 찾기

#### 3단계: I 게인 미세조정
```python
kp = 0.8  # 1단계 값
ki = 0.05 # 시작값
kd = 0.3  # 2단계 값
```
- I 값을 0.01씩 증가시키며 편향 제거
- 너무 높으면 진동 발생 주의

### 환경별 권장 설정

#### 직선 위주 코스
```python
kp = 0.6
ki = 0.05
kd = 0.2
```

#### 곡선 많은 코스
```python
kp = 1.0
ki = 0.1
kd = 0.4
```

#### 고속 주행
```python
kp = 0.4
ki = 0.02
kd = 0.5
```

## 🔧 주요 설정값

### 비전 처리 설정
```python
# ROI (관심 영역) 설정
roi_height = 100    # ROI 높이 (픽셀)
roi_y = 350        # ROI 시작 Y 좌표

# 이진화 임계값
line_threshold = 50  # 낮을수록 더 많은 검은색 검출

# 최소 라인 면적
min_line_area = 500  # 작은 노이즈 제거
```

### 모터 제어 설정
```python
base_speed = 40        # 기본 속도 (0-100)
max_turn_speed = 30    # 최대 회전 속도
```

## 🐛 문제 해결

### 라인을 인식하지 못할 때

#### 1. 조명 확인
- 충분한 조명 확보
- 그림자 제거
- 균일한 조명 환경

#### 2. 임계값 조정
```python
# line_threshold 값 조정
line_threshold = 30   # 더 어두운 색도 검출
# 또는
line_threshold = 70   # 더 검은색만 검출
```

#### 3. ROI 위치 조정
```python
# 카메라 각도에 맞게 ROI 조정
roi_y = 300  # 더 위쪽
# 또는
roi_y = 400  # 더 아래쪽
```

### 진동하거나 불안정할 때

#### 1. PID 파라미터 재조정
- P 게인을 낮춤
- D 게인을 높임

#### 2. 속도 조정
```python
base_speed = 30  # 속도를 낮춤
```

#### 3. 필터링 강화
```python
# 가우시안 블러 강화
blurred = cv2.GaussianBlur(gray, (7, 7), 0)
```

### 한쪽으로 치우칠 때

#### 1. I 게인 추가
```python
ki = 0.1  # 적분 게인 증가
```

#### 2. 카메라 위치 확인
- 카메라가 중앙에 정렬되어 있는지 확인
- 카메라 각도 조정

### 성능이 느릴 때

#### 1. 해상도 낮추기
```python
# 카메라 해상도 조정
self.picam2.preview_configuration.main.size = (320, 240)
```

#### 2. ROI 크기 줄이기
```python
roi_height = 80  # ROI 높이 감소
```

## 📊 디버그 정보 해석

### 화면 표시 요소
- **녹색 사각형**: ROI (관심 영역)
- **흰색 세로선**: 화면 중앙선
- **빨간 원**: 검출된 라인 중심점
- **파란 선**: 중앙선과 라인 중심점 간의 오차
- **청록색 윤곽선**: 검출된 라인 윤곽
- **작은 창**: 이진화된 이미지

### 상태 정보
- **Line Detected**: 라인 검출 여부
- **Steering**: 현재 조향 값 (-30 ~ +30)
- **Base Speed**: 기본 속도
- **FPS**: 초당 프레임 수

## 🎓 학습 팁

### 1. 단계별 학습
1. 먼저 직선에서 테스트
2. 완만한 곡선 추가
3. 급커브와 S자 도전
4. 복합 코스 완주

### 2. 실험해볼 것들
- 다양한 라인 폭 테스트
- 조명 조건 변경
- 속도별 PID 최적화
- 다양한 코스 설계

### 3. 확장 아이디어
- 교차로 인식 및 방향 전환
- 신호등 인식
- 장애물 회피와 라인 트레이싱 결합
- 다중 라인 처리

## 📝 참고 자료

### OpenCV 함수 설명
- `cv2.threshold()`: 이진화 처리
- `cv2.findContours()`: 윤곽선 검출
- `cv2.moments()`: 모멘트 계산으로 중심점 찾기
- `cv2.GaussianBlur()`: 노이즈 제거

### PID 제어 이론
- 비례(P): 현재 오차에 비례한 제어
- 적분(I): 과거 오차의 누적 보정
- 미분(D): 오차 변화율로 미래 예측

---

🎉 **성공적인 라인 트레이싱을 위해 차근차근 따라해보세요!** 